name: Backend CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

# Needed so the workflow can enable auto-merge on PRs
permissions:
  contents: read
  packages: read
  pull-requests: write

concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa:
    name: Lint • Typecheck • Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']  # change to your runtime if needed (e.g., '3.12')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml
            poetry.lock

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
            if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            # Fallback tools if not listed in your reqs
            pip install --upgrade black isort flake8 mypy pytest pytest-cov

      - name: Code style (black)
        run: black --check .

      - name: Imports order (isort)
        run: isort --profile black --check-only .

      - name: Lint (flake8)
        run: flake8 .

      - name: Type check (mypy)
        # Adjust "app" to your project package/module root
        run: mypy app || true

      - name: Run tests
        # Adjust coverage target (app) to your module
        run: pytest -q --maxfail=1 --disable-warnings --cov=app --cov-report=xml

      - name: Upload coverage.xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

  automerge:
    name: Enable Auto-Merge (when labeled)
    needs: qa
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'automerge') }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable PR auto-merge (squash)
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: squash
